generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums

enum RolType {
  SUPER_ADMIN
  SUPERVISOR
  GUIA
}

enum StatusType {
  ACTIVO
  INACTIVO
  SUSPENDIDO
}

enum TurnoStatus {
  CREADO
  EN_USO
  LIBERADO
  TERMINADO
  CANCELADO
}

enum Platform {
  WEB
  MOBILE
}

enum ProfileStatus {
  INCOMPLETE
  COMPLETE
}

enum DocumentType {
  CC
  CE
  PAS
  NIT
  OTRO
}

enum InvitationStatus {
  PENDING
  USED
  EXPIRED
}

// Modelos
model Usuario {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String
  nombres      String
  apellidos    String
  rol          RolType
  activo       Boolean @default(true)

  // Onboarding
  profileStatus      ProfileStatus @default(INCOMPLETE)
  profileCompletedAt DateTime?

  // Documento de identidad (obligatorio al completar perfil)
  documentType   DocumentType?
  documentNumber String?
  telefono       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  guia          Guia?
  supervisor    Supervisor?
  refreshTokens RefreshToken[]
  sessions      Session[]

  // Invitaciones (quien invita y la invitación recibida)
  sentInvitations    Invitation[] @relation("InviterRelation")
  receivedInvitation Invitation?  @relation("InviteeRelation")

  // Índices de búsqueda/filtrado por documento
  @@index([documentType, documentNumber])

  // Unicidad estricta documento (activar si lo decides)
  // @@unique([documentType, documentNumber])

  @@map("usuarios")
}

model Invitation {
  id               String           @id @default(cuid())
  email            String
  role             RolType
  tempPasswordHash String
  tokenHash        String?          @unique
  status           InvitationStatus @default(PENDING)
  expiresAt        DateTime
  usedAt           DateTime?

  // Quien invita
  inviterId String
  inviter   Usuario @relation("InviterRelation", fields: [inviterId], references: [id], onDelete: Cascade)

  // Usuario invitado (opcional si lo pre-creas; único para evitar duplicidad 1:1)
  userId String?  @unique
  user   Usuario? @relation("InviteeRelation", fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Índices útiles
  @@index([email])
  @@index([status])
  @@index([expiresAt])

  @@map("invitations")
}

model Session {
  id     String  @id @default(cuid())
  userId String
  user   Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Plataforma / dispositivo
  platform  Platform
  deviceId  String?
  userAgent String?
  ip        String?

  // Refresh token rotatorio (hash, nunca el valor en claro)
  refreshTokenHash String?   @unique
  refreshExpiresAt DateTime?
  lastRotatedAt    DateTime?

  // Estado de sesión
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  revokedAt DateTime?

  // Índices
  @@index([userId, platform])
  @@index([deviceId])

  @@map("sessions")
}

model RefreshToken {
  id           String         @id @default(cuid())
  userId       String
  usuario      Usuario        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash    String         @unique
  issuedAt     DateTime       @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  replacedBy   RefreshToken?  @relation("Replacements", fields: [replacedById], references: [id])
  replacements RefreshToken[] @relation("Replacements")
  ip           String?
  userAgent    String?
  deviceId     String?

  @@index([userId])
  @@index([expiresAt])
  @@index([revokedAt])

  @@map("refresh_tokens")
}

model Guia {
  id        String   @id @default(cuid())
  usuarioId String   @unique
  telefono  String?
  direccion String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  turnos  Turno[]

  @@map("guias")
}

model Supervisor {
  id        String   @id @default(cuid())
  usuarioId String   @unique
  telefono  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario    Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  recaladas  Recalada[]
  atenciones Atencion[]

  @@map("supervisores")
}

model Pais {
  id        Int        @id @default(autoincrement())
  nombre    String     @unique
  codigo    String     @unique // ISO code
  status    StatusType @default(ACTIVO)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  recaladas Recalada[]

  @@map("paises")
}

model Buque {
  id        Int        @id @default(autoincrement())
  nombre    String     @unique
  naviera   String?
  capacidad Int?
  status    StatusType @default(ACTIVO)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  recaladas Recalada[]

  @@map("buques")
}

model Recalada {
  id            Int        @id @default(autoincrement())
  buqueId       Int
  paisOrigenId  Int
  supervisorId  String
  fechaLlegada  DateTime
  fechaSalida   DateTime?
  observaciones String?
  status        StatusType @default(ACTIVO)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  buque      Buque      @relation(fields: [buqueId], references: [id])
  paisOrigen Pais       @relation(fields: [paisOrigenId], references: [id])
  supervisor Supervisor @relation(fields: [supervisorId], references: [id])
  atenciones Atencion[]

  @@map("recaladas")
}

model Atencion {
  id           Int        @id @default(autoincrement())
  recaladaId   Int
  supervisorId String
  turnosTotal  Int
  descripcion  String?
  fechaInicio  DateTime
  fechaFin     DateTime?
  status       StatusType @default(ACTIVO)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  recalada   Recalada   @relation(fields: [recaladaId], references: [id])
  supervisor Supervisor @relation(fields: [supervisorId], references: [id])
  turnos     Turno[]

  @@map("atenciones")
}

model Turno {
  id            Int         @id @default(autoincrement())
  atencionId    Int
  guiaId        String?
  numero        Int         // correlativo
  status        TurnoStatus @default(CREADO)
  fechaInicio   DateTime?
  fechaFin      DateTime?
  observaciones String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  atencion Atencion @relation(fields: [atencionId], references: [id])
  guia     Guia?    @relation(fields: [guiaId], references: [id])

  @@unique([atencionId, numero])

  @@map("turnos")
}
