generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums

enum RolType {
  SUPER_ADMIN
  SUPERVISOR
  GUIA
}

enum StatusType {
  ACTIVO
  INACTIVO
  SUSPENDIDO
}

// NUEVO: estados del Turno como slot materializado
enum TurnoStatus {
  AVAILABLE     // slot libre
  ASSIGNED      // slot asignado a un guía
  IN_PROGRESS   // (opcional) en curso
  COMPLETED     // terminado
  CANCELED      // cancelado
  NO_SHOW       // (opcional) no se presentó
}

enum Platform {
  WEB
  MOBILE
}

enum ProfileStatus {
  INCOMPLETE
  COMPLETE
}

enum DocumentType {
  CC
  CE
  PAS
  NIT
  OTRO
}

enum InvitationStatus {
  PENDING
  USED
  EXPIRED
}

// NUEVO: estado operativo real de una recalada (independiente de StatusType)
enum RecaladaOperativeStatus {
  SCHEDULED
  ARRIVED
  DEPARTED
  CANCELED
}

// Opcional pero útil para futuro: origen/forma de creación
enum RecaladaSource {
  MANUAL
  IMPORT
  API
}

// NUEVO: estado operativo de Atención
enum AtencionOperativeStatus {
  OPEN
  CLOSED
  CANCELED
}

model Usuario {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String
  nombres      String
  apellidos    String
  rol          RolType
  activo       Boolean @default(true)

  profileStatus      ProfileStatus @default(INCOMPLETE)
  profileCompletedAt DateTime?

  documentType   DocumentType?
  documentNumber String?
  telefono       String?

  emailVerifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guia          Guia?
  supervisor    Supervisor?
  refreshTokens RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  sessions      Session[]

  sentInvitations    Invitation[] @relation("InviterRelation")
  receivedInvitation Invitation?  @relation("InviteeRelation")

  // Auditoría Atenciones
  atencionesCreadas   Atencion[] @relation("AtencionCreatedBy")
  atencionesCanceladas Atencion[] @relation("AtencionCanceledBy")

  // Auditoría Turnos
  turnosCreados     Turno[] @relation("TurnoCreatedBy")
  turnosCancelados  Turno[] @relation("TurnoCanceledBy")

  @@index([documentType, documentNumber])
  @@index([emailVerifiedAt])
  @@map("usuarios")
}

model Invitation {
  id               String           @id @default(cuid())
  email            String
  role             RolType
  tempPasswordHash String
  tokenHash        String?          @unique
  status           InvitationStatus @default(PENDING)
  expiresAt        DateTime
  usedAt           DateTime?

  inviterId String
  inviter   Usuario @relation("InviterRelation", fields: [inviterId], references: [id], onDelete: Cascade)

  userId String?  @unique
  user   Usuario? @relation("InviteeRelation", fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

model PasswordResetToken {
  id        String   @id @default(cuid())

  userId    String
  user      Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())

  userId    String
  user      Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("email_verification_tokens")
}

model Session {
  id     String  @id @default(cuid())
  userId String
  user   Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform  Platform
  deviceId  String?
  userAgent String?
  ip        String?

  refreshTokenHash String?   @unique
  refreshExpiresAt DateTime?
  lastRotatedAt    DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  revokedAt DateTime?

  @@index([userId, platform])
  @@index([deviceId])
  @@map("sessions")
}

model RefreshToken {
  id           String         @id @default(cuid())
  userId       String
  usuario      Usuario        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash    String         @unique
  issuedAt     DateTime       @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  replacedBy   RefreshToken?  @relation("Replacements", fields: [replacedById], references: [id])
  replacements RefreshToken[] @relation("Replacements")
  ip           String?
  userAgent    String?
  deviceId     String?

  @@index([userId])
  @@index([expiresAt])
  @@index([revokedAt])
  @@map("refresh_tokens")
}

model Guia {
  id        String   @id @default(cuid())
  usuarioId String   @unique
  telefono  String?
  direccion String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  turnos  Turno[]

  @@map("guias")
}

model Supervisor {
  id        String   @id @default(cuid())
  usuarioId String   @unique
  telefono  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario    Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  recaladas  Recalada[]
  atenciones Atencion[]

  @@map("supervisores")
}

model Pais {
  id        Int        @id @default(autoincrement())
  nombre    String     @unique
  codigo    String     @unique
  status    StatusType @default(ACTIVO)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  recaladas Recalada[]
  buques    Buque[]

  @@index([status])
  @@map("paises")
}

model Buque {
  id        Int        @id @default(autoincrement())
  codigo    String     @unique
  nombre    String     @unique
  naviera   String?
  capacidad Int?
  status    StatusType @default(ACTIVO)
  paisId    Int?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  pais      Pais?     @relation(fields: [paisId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  recaladas Recalada[]

  @@index([paisId])
  @@index([status])
  @@map("buques")
}

model Recalada {
  id           Int    @id @default(autoincrement())
  buqueId      Int
  paisOrigenId Int
  supervisorId String

  // Identidad operativa (soporte/imports/búsqueda)
  codigoRecalada String @unique

  // Fechas programadas (agenda)
  fechaLlegada DateTime
  fechaSalida  DateTime?

  // Fechas reales (operación)
  arrivedAt  DateTime?
  departedAt DateTime?

  // Estado del registro (soft enable/disable) + estado operativo real
  status            StatusType              @default(ACTIVO)
  operationalStatus RecaladaOperativeStatus @default(SCHEDULED)

  // Datos operativos (UI feliz)
  terminal           String?
  muelle             String?
  pasajerosEstimados Int?
  tripulacionEstimada Int?
  observaciones       String?
  fuente              RecaladaSource @default(MANUAL)

  // Auditoría de cancelación
  canceledAt   DateTime?
  cancelReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  buque      Buque      @relation(fields: [buqueId], references: [id])
  paisOrigen Pais       @relation(fields: [paisOrigenId], references: [id])
  supervisor Supervisor @relation(fields: [supervisorId], references: [id])
  atenciones Atencion[]

  // Índices para filtros típicos (calendario/listados)
  @@index([fechaLlegada])
  @@index([buqueId, fechaLlegada])
  @@index([operationalStatus, fechaLlegada])
  @@index([paisOrigenId, fechaLlegada])
  @@map("recaladas")
}

model Atencion {
  id           Int        @id @default(autoincrement())
  recaladaId   Int
  supervisorId String

  // Cupo materializable: al crear Atencion, se crean Turnos 1..turnosTotal
  turnosTotal  Int

  descripcion  String?

  // Ventana operativa (cerrada, siempre)
  fechaInicio  DateTime
  fechaFin     DateTime

  // Estado admin del registro
  status       StatusType @default(ACTIVO)

  // Estado operativo
  operationalStatus AtencionOperativeStatus @default(OPEN)

  // Auditoría
  createdById  String
  canceledAt   DateTime?
  cancelReason String?
  canceledById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recalada   Recalada   @relation(fields: [recaladaId], references: [id])
  supervisor Supervisor @relation(fields: [supervisorId], references: [id])

  createdBy  Usuario @relation("AtencionCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  canceledBy Usuario? @relation("AtencionCanceledBy", fields: [canceledById], references: [id], onDelete: SetNull)

  turnos Turno[]

  @@index([recaladaId])
  @@index([supervisorId])
  @@index([status])
  @@index([operationalStatus])
  @@index([recaladaId, fechaInicio])
  @@map("atenciones")
}

model Turno {
  id         Int    @id @default(autoincrement())
  atencionId Int

  // Slot asignable a un guía (nullable si está libre)
  guiaId     String?

  // Cupón numerado 1..N
  numero     Int

  status     TurnoStatus @default(AVAILABLE)

  // Por defecto heredan de la Atención, pero se dejan opcionales por flexibilidad futura
  fechaInicio DateTime?
  fechaFin    DateTime?

  observaciones String?

  // Operación real
  checkInAt  DateTime?
  checkOutAt DateTime?

  // Auditoría
  createdById String
  canceledAt  DateTime?
  cancelReason String?
  canceledById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  atencion Atencion @relation(fields: [atencionId], references: [id])
  guia     Guia?    @relation(fields: [guiaId], references: [id])

  createdBy  Usuario @relation("TurnoCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  canceledBy Usuario? @relation("TurnoCanceledBy", fields: [canceledById], references: [id], onDelete: SetNull)

  // Reglas de integridad
  @@unique([atencionId, numero])
  @@unique([atencionId, guiaId])

  @@index([atencionId])
  @@index([guiaId])
  @@index([status])
  @@map("turnos")
}
